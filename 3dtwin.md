# 3D Body Twin Viewer

Interactive Three.js organ viewer that visualizes organ-level health findings from the analysis pipeline.

## How It Works

The pipeline generates `organ_insights.md` (Phase 6) with per-organ clinical findings. The server parses this markdown into structured JSON via `/api/realms/:realmId/body-twin`. The React client renders the data as an interactive 3D body model with clickable organs, health panels, and cross-organ connection lines.

**Data flow:**
```
organ_insights.md ‚Üí server transformer ‚Üí BodyTwinData JSON ‚Üí React 3D viewer
```

## Prerequisites

- GLB models in `client/public/models/` (`human_organ.glb`, `skeleton.glb`, `brain.glb`)
- `organ_insights.md` in `storage/` (generated by a full pipeline run)
- Client dependencies installed (`cd client && npm install`)

## Running

### Normal Mode (Full Pipeline)

1. Start both servers:
   ```bash
   # Terminal 1
   cd server && npm run dev

   # Terminal 2
   cd client && npm run dev
   ```

2. Open `http://localhost:5173`

3. Upload documents, enter a prompt, click **Generate Realm**

4. When the pipeline finishes, the success screen shows three buttons:
   - **Enter Realm** ‚Äî opens the generated HTML report
   - **3D Body View** ‚Äî launches the interactive 3D organ viewer
   - **Create New** ‚Äî resets for another run

### Regen Mode (Regenerate HTML Only)

Use this when you already have `structured_data.json` and `organ_insights.md` from a previous run and want to regenerate just the HTML.

1. Regenerate HTML:
   ```bash
   cd server && npm run regen-html
   # Optionally pass a prompt:
   # npm run regen-html -- "Focus on cardiovascular health"
   ```

2. The script prints two URLs:
   ```
   üåê View HTML: http://localhost:3000/realms/<uuid>/index.html
   üñ•Ô∏è  Full UI (+ 3D Body View): http://localhost:5173?realm=<uuid>
   ```

3. To view the HTML report only, start the server and open the first URL:
   ```bash
   cd server && npm run dev
   # Open http://localhost:3000/realms/<uuid>/index.html
   ```

4. To access the 3D Body View, start both servers and open the second URL:
   ```bash
   # Terminal 1
   cd server && npm run dev

   # Terminal 2
   cd client && npm run dev

   # Open http://localhost:5173?realm=<uuid>
   ```

## 3D Viewer Features

- **Organ selection** ‚Äî click any organ on the 3D model to view its health data
- **Hover highlighting** ‚Äî green = selected, yellow = hovered
- **Health panel** ‚Äî shows status, metrics, clinical findings, and recommendations for the selected organ
- **Connection lines** ‚Äî animated lines between organs with cross-organ relationships
- **System selector** ‚Äî toggle visibility of body systems (cardiovascular, digestive, etc.)
- **Zoom controls** ‚Äî slider and +/- buttons to zoom in/out
- **Organs without meshes** ‚Äî organs like Thyroid or Pancreas that don't have 3D models still appear in the sidebar and are clickable

## API

```
GET /api/realms/:realmId/body-twin
```

Returns `BodyTwinData` JSON parsed from `storage/organ_insights.md`. Returns 404 if organ insights are not available.

## Key Files

| File | Purpose |
|------|---------|
| `client/src/body-twin/BodyTwinPage.tsx` | Top-level page component |
| `client/src/body-twin/components/BodyViewer.tsx` | Three.js canvas with camera and lighting |
| `client/src/body-twin/components/OrganMeshes.tsx` | GLB model loading, organ click/hover |
| `client/src/body-twin/components/HealthPanel.tsx` | Sidebar with organ health data |
| `client/src/body-twin/components/ConnectionLines.tsx` | Animated lines between related organs |
| `client/src/body-twin/components/SystemSelector.tsx` | Body system visibility toggles |
| `client/src/body-twin/store/bodyTwinStore.ts` | Zustand state management |
| `client/src/body-twin/lib/organMapping.ts` | Clinical name to GLB mesh name mapping |
| `server/src/services/body-twin-transformer.service.ts` | Parses organ_insights.md to JSON |
| `server/src/adapters/http/server.ts` | `/api/realms/:realmId/body-twin` endpoint |
